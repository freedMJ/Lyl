

{%load static%}
{% load filters %}
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>联金数据库查询系统</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" src="{% static 'js/jquery.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/djangoajax.js' %}"></script>
    <script type="text/javascript">
    	$(document).ready(function(){
    		 
    		//获得当前时间戳
    		var token = $('input[name=csrfmiddlewaretoken]').val();
    		var end_timestamp =Date.parse(new Date())
    		//装换成当前时间
    		var end_time=timestampToTime(end_timestamp)
    		//获得过去一小时时间戳
    		var start_timestamp=end_timestamp-3600000;
    		//转化成过去一小时时间
    		var start_time=timestampToTime(start_timestamp);
    		$("#startTime").val(start_time);
    		$("#endTime").val(end_time);

    		//页面加载自动查询过去一小时的全部订单
    		$.ajax({
    			url:"/result_ajax",
    			type:"post",
    			data: {csrfmiddlewaretoken: token,
						"start_timestamp":start_timestamp/1000,
						"end_timestamp":end_timestamp/1000

						},
				success:function(data){
					
					console.log(data.olists[0])
					
				}


    		})
    		$("#bt").click(function(){
    			//获得开始时间戳和结束时间戳
    			var start_time=$("#startTime").val();
    			var end_time=$("#endTime").val();
    			//判断输入的时间格式是否正确
    			var reg=/^[1-9]\d{3}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])\s+(20|21|22|23|[0-1]\d):[0-5]\d:[0-5]\d$/;
    			var start_time_z=start_time.match(reg);
    			var end_time_z=end_time.match(reg);
    			//获得选择查询方式
				var orderMethod=$("#orderMethod").val();
				//获得用户标识
				var usertoken=$("#usertoken").val();
				//获得订单号
				var orderno=$("#orderno").val();
				//获得订单种类，分发联金状态
    			var orderType=$("#orderType").val();
    			var isfilled=$("#isfilled").val()
				//根据选择查询方式不同，发送不同请求
				if(orderMethod=="0"){
					alert("查询方式必选，请选择一种")
				}
				
				//查询时间范围内的订单
				if(orderMethod=="1"){
					//alert("查询时间范围内订单")
					if(start_time_z==null){
    				 	alert("请输入正确的开始时间,开始时间必填")
					}
					if(end_time_z==null){
						alert("请输入正确的结束时间，结束时间必填")
					}
					//输入的时间格式正确，转化成时间戳
 					var start_timestamp=timeToTimestamp(start_time);
 					var end_timestamp=timeToTimestamp(end_time);
 					var dict=new Array();
 					dict[0]="start_timestamp";
 					dict[1]=start_timestamp;
 					dict[2]="end_timestamp";
 					dict[3]=end_timestamp;
 					if((usertoken.length)>0){
 						var tmp_str="usertoken";
 						dict.push(tmp_str)
 						dict.push(usertoken)
 					};
 					if((orderno.length)>0){
 						var tmp_str="orderno";
 						dict.push(tmp_str)
 						dict.push(orderno)
 					}
 					//获得json数据
 					json_data=arrayToJSON(dict)
 					alert(json_data)
 					//$.post("/result_ajax",function(){
 					//	alert("success")
 					//})
 					$.ajax({
						url: '/result_ajax',
						type: 'post',
						data: {csrfmiddlewaretoken: token,
							"json_data":json_data

						},
						dataType: 'json',
						success: function () {
                			alert("aaa")
            			}
        })


 					//调用ajax
 					//$.ajax({
 					//	url:"/result_ajax/",
 					//	type:"get",
 						//headers:{"X-CSRFToken":$.cookie('csrftoken')},
 						//data:JSON.stringify(json_data),
 						//data:json_data,
 						//contentType: "application/json; charset=UTF-8",
 						//dataType:"json",
 					//})
 					

				}

				//根据用户标识查询订单
				else if(orderMethod=="2"){
					alert("根据用户标识查询订单")
				}
				//根据订单号查询订单
				else if(orderMethod=="3"){
					alert("根据订单号查询订单")
				}
    			
    			
    			   			
    			
    			//判断订单种类，分发联金状态是否选择
    			if(orderType=="0"){
    				alert("请选择订单种类")
    			};
    			if(isfilled=="0"){
    				alert("请选择分发联金状态")
    			};
    			var data={
    				"start_timestamp":start_timestamp,
    				"end_timestamp":end_timestamp,
    				"orderType":orderType,
    				"isfilled":isfilled
    			}
    			var data_json=JSON.stringify(data);
    			//调用ajax向后端传输数据


    		});
    	});


    	//得到时间
    	function timestampToTime(timestamp) {
     		var date = new Date(timestamp);//时间戳为10位需*1000，时间戳为13位的话不需乘1000
     		var Y = date.getFullYear() + '-';
     		var M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '-';
     		var D = date.getDate() + ' ';
     		var h = date.getHours();
     		if(h<10){
     			h='0'+h+ ':';;
     		}else{
     			h=h+ ':';
     		}
     		var m = date.getMinutes();
     		if(m<10){
     			m='0'+m+ ':';;
     		}else{
     			m=m+ ':';
     		}
     		var s = date.getSeconds();
     		if(s<10){
     			s='0'+s;
     		}else{
     			s=s;
     		}
     		return Y+M+D+h+m+s;
    	}
     	//得到时间戳
     	function timeToTimestamp(time){
     		var time_str=time+":000";
     		var s =time_str;
            s = s.replace(/-/g,"/");
     		var date = new Date(s);
		    // 有三种方式获
		    var timestamp =(Date.parse(date))/1000;
		    return timestamp;
     	}
     	//数组变成json
     	function arrayToJSON(data){
     		var json_str=""
     		for(j = 0; j < data.length; j++) {
     			
     			if(j>0&&j%2==1){//
     				var temp_str=",";
     				var str_key=data[j-1];
     				var str_vlaue=data[j];
     				temp_str="'"+str_key+"':"+"'"+str_vlaue+"'"+","
     				json_str+=temp_str
     			}
			}
			new_json="{"+json_str.replace(/'/g,'"')+"}"
			//json_data=JSON.stringify(new_json)
			return new_json
			//return json_data
     	}
    
   
    </script>
  </head>
  <body>
    <div >
	<div style="display: inline; bottom: 30px;" >
	<h1 style="display: inline; " >联金数据库查询系统 </h1>
	</div>
	<span><img src="{% static 'images/1528175965.png' %}" style="height: 73px;width: 255px;" id="im"></span><br>
	<form class="form-inline">
		{% csrf_token %}
		查询方式<select class="form-control" id="orderMethod">
			<option value="0">--请选择查询方式(必选)--</option>
			<option value="1">查询时间范围内订单</option>
			<option value="2">根据用户标识查询订单</option>
			<option value="3">根据订单号查询订单</option>
        </select>
		<div class="form-group">
		  <label for="exampleInputName2">开始时间</label>
		  <input type="text" class="form-control" id="startTime" style="width: 160px">
		</div>
		<div class="form-group">
		  <label for="exampleInputName2" >结束时间</label>
		  <input type="text" class="form-control" id="endTime" style="width: 160px">
		</div>
		<div class="form-group">
		  <label for="exampleInputName2">用户标识</label>
		  <input type="text" class="form-control" id="usertoken" style="width: 150px">
		</div>
		<div class="form-group">
		  <label for="exampleInputName2">订单号</label>
		  <input type="text" class="form-control" id="orderno" style="width: 150px">
		</div>
		<select class="form-control" id="orderType">
			<option value="0">--请选择订单种类--</option>
			<option value="1">全部订单</option>
			<option value="2">按摩枕订单</option>
			<option value="3">游戏订单</option>
        </select>
        <select class="form-control" id="isfilled">
        	<option value="0">--请选择分发联金状态--</option>
			<option value="1">已分发和未分发总订单</option>
			<option value="2">已分发联金订单</option>
			<option value="3">未分发联金订单</option>
        </select>
		<button type="button" class="btn btn-default" id="bt">查询</button>
    </form>
	<a href="/index">返回首页</a>
	{% if olength == 0 %}
		<p>当前联金都已经正常发放了</p>
	{% else  %}
		<p style="color: red">当前共{{olength}}笔交易未分发成功联金</p>
		<p style="color: red">当前共{{len_pindex}}页，一页共25条记录，当前是第{{page.number}}页</p>
	{% endif %}
	

	</div>
    <table class="table table-condensed">
  		
  		<thead >
			<tr>
				<th>交易记录</th>
				<th>id</th>
				<th>用户标识</th>
				<th>订单号</th>
				<th>交易服务费</th>
				<th>交易时间</th>
				<th>是否分发</th>
			</tr>
		</thead>
		<tbody>	
			{% for o in page.object_list %}
			<tr>
				<td>{{forloop.counter}}</td>
				<td>{{o.id}}</td>
				<td>{{o.usertoken}}</td>
				<td>{{o.orderno}}</td>
				<td>{{o.orderamount}}</td>
				<td>{{ o.created_at|get_times}}</td>
				<!--<td>{{ o.created_at}}</td>-->
				{% if o.is_filled == 0 %}
					<td style="color: red">未分发</td>
				{% else %}
					<td style="color: green">已分发</td>
				{% endif %}
				<td>{{o.source_id}}</td>
			</tr>
			{% endfor %}
		</tbody>
		<nav aria-label="Page navigation">
					<ul class="pagination">

					  {% if  page.previous_page_number > 0 %}
					  <li>
					    <a href="/result_time{{page.previous_page_number}}" aria-label="Previous">
					      <span aria-hidden="true">«</span>
					    </a>
					  </li>
					  {% endif %}

					  {% for page_num in page_list %}
					          {% if page_num == page.number %}
					              <li class="active"><a href="#" ">{{ page_num }}</a></li>
					          {% else %}
					              <li><a href="/result_time{{ page_num }}">{{ page_num }}</a></li>
					          {% endif %}
					  {% endfor %}

					  {% if page.has_next %}
					  <li>
					    <a href="/result_time{{page.next_page_number}}" aria-label="Next">
					      <span aria-hidden="true">»</span>
					    </a>
					  </li>
					  {% endif %}

					</ul>
        </nav>
			   </table>

			    <!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
			    <script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
			    <!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
			    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
  </body>
</html>